<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§í•˜ê¸° ë ˆë²¨ 1 - 10,000 ë¬¸ì¥ ë„ì „</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root { --primary-color: #4A90E2; --correct-color: #2ECC71; --wrong-color: #E74C3C; }
        body { font-family: 'Pretendard', sans-serif; background: #f5f7f9; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        #app { background: white; width: 100%; max-width: 500px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        .list-info { font-size: 14px; color: #666; margin-bottom: 10px; }
        .question-box { font-size: 24px; font-weight: bold; margin: 20px 0; color: #333; min-height: 60px; }
        .hint { font-size: 16px; color: #999; margin-bottom: 20px; }
        .voice-input-area { background: #f9f9f9; border: 2px dashed #ddd; border-radius: 15px; padding: 20px; min-height: 80px; margin-bottom: 20px; font-size: 20px; color: var(--primary-color); display: flex; align-items: center; justify-content: center; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { border: none; border-radius: 12px; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #recordBtn { background: var(--primary-color); color: white; grid-column: span 2; }
        #recordBtn.recording { background: var(--wrong-color); animation: pulse 1.5s infinite; }
        #gradeBtn { background: #555; color: white; }
        #nextBtn { background: #eee; color: #333; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        /* ê²°ê³¼ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #resultView { display: none; background: white; padding: 20px; border-radius: 20px; text-align: center; width: 100%; max-width: 400px; }
        .score-card { border: 2px solid #eee; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .report-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
        #saveBtn { background: var(--correct-color); color: white; width: 100%; }
    </style>
</head>
<body>

<div id="app">
    <div class="list-info" id="currentInfo">Loading...</div>
    <div class="question-box" id="koreanQ">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>
    <div class="hint" id="hintWord"></div>
    
    <div class="voice-input-area" id="spokenText">ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§í•˜ì„¸ìš”</div>

    <div class="btn-group">
        <button id="recordBtn">ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
        <button id="gradeBtn">ì±„ì í•˜ê¸°</button>
        <button id="nextBtn" disabled>ë‹¤ìŒ ë¬¸ì¥</button>
    </div>
</div>

<div id="resultView">
    <h2>Speaking Report</h2>
    <div class="score-card" id="captureArea">
        <h3 id="reportTitle">Level 1 - List 1</h3>
        <div id="reportDetails"></div>
        <hr>
        <div style="font-size: 20px; font-weight: bold; color: var(--primary-color);">ì ìˆ˜: <span id="finalScore">0</span> / 10</div>
    </div>
    <button id="saveBtn">PNGë¡œ ì €ì¥ í›„ ì¹´í†¡ ì „ì†¡</button>
</div>

<script>
    let allData = [];
    let currentList = [];
    let currentIndex = 0;
    let results = [];
    
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;

    // 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    fetch('speaking_lv1.json')
        .then(res => res.json())
        .then(data => {
            allData = data;
            startList(1); // ìš°ì„  ë¦¬ìŠ¤íŠ¸ 1ë²ˆë¶€í„° ì‹œì‘ (ë‚˜ì¤‘ì— ì„ íƒ ê¸°ëŠ¥ ì¶”ê°€ ê°€ëŠ¥)
        });

    function startList(no) {
        currentList = allData.filter(item => item.List_No == no);
        currentIndex = 0;
        results = [];
        showQuestion();
    }

    function showQuestion() {
        const item = currentList[currentIndex];
        document.getElementById('currentInfo').innerText = `Level ${item.Level} - List ${item.List_No} (${currentIndex + 1}/10)`;
        document.getElementById('koreanQ').innerText = item.Korean;
        document.getElementById('hintWord').innerText = `Hint: ${item.Hint}`;
        document.getElementById('spokenText').innerText = "ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§í•˜ì„¸ìš”";
        document.getElementById('spokenText').style.color = "#4A90E2";
        document.getElementById('nextBtn').disabled = true;
    }

    // 2. ë…¹ìŒ ê¸°ëŠ¥
    const recordBtn = document.getElementById('recordBtn');
    recordBtn.onclick = () => {
        recognition.start();
        recordBtn.innerText = "ğŸ”´ ë“£ê³  ìˆì–´ìš”...";
        recordBtn.classList.add('recording');
    };

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        document.getElementById('spokenText').innerText = text;
        recordBtn.innerText = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
        recordBtn.classList.remove('recording');
    };

    recognition.onerror = () => {
        alert("ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        recordBtn.innerText = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
        recordBtn.classList.remove('recording');
    };

    // 3. ì±„ì  ê¸°ëŠ¥
    document.getElementById('gradeBtn').onclick = () => {
        const spoken = document.getElementById('spokenText').innerText.toLowerCase().replace(/[.,?!]/g, "").trim();
        const answer = currentList[currentIndex].English.toLowerCase().replace(/[.,?!]/g, "").trim();
        
        const isCorrect = spoken === answer;
        results.push({ q: currentList[currentIndex].Korean, a: currentList[currentIndex].English, user: spoken, ok: isCorrect });

        if (isCorrect) {
            document.getElementById('spokenText').innerText = "Perfect! ğŸ‘";
            document.getElementById('spokenText').style.color = "var(--correct-color)";
        } else {
            document.getElementById('spokenText').innerText = "Try Again! âŒ";
            document.getElementById('spokenText').style.color = "var(--wrong-color)";
        }
        document.getElementById('nextBtn').disabled = false;
    };

    // 4. ë‹¤ìŒ ë²„íŠ¼
    document.getElementById('nextBtn').onclick = () => {
        currentIndex++;
        if (currentIndex < 10) {
            showQuestion();
        } else {
            showReport();
        }
    };

    // 5. ì„±ì í‘œ ì¶œë ¥
    function showReport() {
        document.getElementById('app').style.display = 'none';
        document.getElementById('resultView').style.display = 'block';
        
        let reportHtml = "";
        let correctCount = 0;
        results.forEach((res, i) => {
            if (res.ok) correctCount++;
            reportHtml += `
                <div class="report-item">
                    <span>${i+1}. ${res.q}</span>
                    <span style="color: ${res.ok ? 'green' : 'red'}">${res.ok ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'}</span>
                </div>`;
        });
        
        document.getElementById('reportDetails').innerHTML = reportHtml;
        document.getElementById('finalScore').innerText = correctCount;
        document.getElementById('reportTitle').innerText = `Level 1 - List ${currentList[0].List_No} ì„±ì í‘œ`;
    }

    // 6. PNG ì €ì¥ ê¸°ëŠ¥
    document.getElementById('saveBtn').onclick = () => {
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const link = document.createElement('a');
            link.download = `Speaking_Report_List${currentList[0].List_No}.png`;
            link.href = canvas.toDataURL();
            link.click();
            alert("ì„±ì í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹´í†¡ìœ¼ë¡œ ê³µìœ í•´ì£¼ì„¸ìš”.");
        });
    };
</script>

</body>
</html>