<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Master #32 - Final Fix</title>
    <style>
        :root {
            --pink: #FFEDFA; --mint: #E6FFFA; --blue: #EBF8FF;
            --point-pink: #F687B3; --point-mint: #38B2AC; --point-blue: #4299E1;
            --text: #2D3748;
        }
        body { font-family: 'Pretendard', sans-serif; margin: 0; background: #F7FAFC; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .phone-container { width: 100%; max-width: 450px; height: 100%; background: white; display: flex; flex-direction: column; position: relative; }
        .header { padding: 12px; text-align: center; font-weight: bold; color: var(--point-blue); border-bottom: 1px solid #eee; background: white; font-size: 0.95rem; }
        #display-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }

        .intro-container { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .main-title-card { width: 100%; background: linear-gradient(135deg, #63B3ED 0%, #4299E1 100%); padding: 35px 20px; border-radius: 20px; color: white; margin-bottom: 20px; box-sizing: border-box; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .main-title-card h1 { margin: 0; font-size: 1.5rem; }
        .intro-summary { background: var(--blue); padding: 18px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #BEE3F8; text-align: left; font-size: 0.92rem; line-height: 1.6; width: 100%; box-sizing: border-box; }
        .intro-summary h3 { margin: 0 0 10px 0; color: #2C5282; border-bottom: 1px dashed #A7D7F5; padding-bottom: 5px; }
        .intro-topic { background: #FFF5F7; padding: 18px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #FED7E2; text-align: left; width: 100%; box-sizing: border-box; }
        .topic-label { color: var(--point-pink); font-weight: bold; font-size: 0.8rem; display: block; margin-bottom: 5px; }
        .btn-start { background: var(--point-blue); color: white; padding: 18px; border-radius: 15px; border: none; font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }

        .sentence-box { background: var(--blue); padding: 25px; border-radius: 20px; font-size: 1.2rem; font-weight: 700; color: #2C5282; margin-bottom: 15px; border: 2px solid #BEE3F8; line-height: 1.5; }
        .translation { font-size: 1.05rem; color: #4A5568; background: var(--pink); padding: 15px; border-radius: 15px; margin-bottom: 15px; border-left: 5px solid var(--point-pink); line-height: 1.6; }
        .voca-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .voca-item { background: var(--mint); padding: 10px; border-radius: 10px; font-size: 0.85rem; border: 1px solid #B2F5EA; cursor: pointer; text-align: center; font-weight: 600; }
        .voca-item.revealed { background: var(--point-mint); color: white; border-color: var(--point-mint); }
        .grammar-box { background: #FFF5F7; padding: 15px; border-radius: 15px; border: 1px solid #FED7E2; font-size: 0.85rem; margin-bottom: 10px; }
        .test-card { background: #fff; padding: 25px; border-radius: 20px; border: 2px dashed var(--point-pink); font-size: 1.3rem; line-height: 1.8; text-align: center; }
        .blank { border-bottom: 3px solid var(--point-pink); color: transparent; cursor: pointer; margin: 0 3px; display: inline-block; min-width: 45px; }
        .blank.revealed { color: var(--point-pink); font-weight: bold; border-bottom: 3px solid transparent; }
        .order-box { background: #fff; border: 2px solid #E2E8F0; padding: 18px; border-radius: 15px; margin-bottom: 12px; cursor: pointer; font-size: 0.95rem; position: relative; color: #4A5568; }
        .order-box.selected { border-color: var(--point-mint); background: var(--mint); }
        .order-num { position: absolute; right: 10px; top: 10px; background: var(--point-mint); color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; display: none; }
        .order-box.selected .order-num { display: flex; }
        .drag-target-zone { background: #FFF9C4; border: 2px dashed #FBC02D; padding: 12px; border-radius: 12px; font-weight: bold; color: #827717; text-align: center; cursor: grab; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.4; touch-action: none; }
        .passage-container { background: #fff; padding: 12px; border-radius: 15px; border: 1px solid #E2E8F0; line-height: 2.3; color: #4A5568; font-size: 0.85rem; }
        .num-spot { display: inline-flex; width: 22px; height: 22px; background: #fff; border: 1.5px solid var(--point-blue); color: var(--point-blue); border-radius: 50%; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; margin: 0 8px; vertical-align: middle; cursor: pointer; }
        .num-spot.correct-spot { background: var(--point-mint); border-color: var(--point-mint); color: white; }
        .num-spot.wrong-spot { background: #E53E3E; border-color: #E53E3E; color: white; }

        .writing-input { width: 100%; height: 100px; padding: 15px; border-radius: 15px; border: 2px solid #E2E8F0; font-size: 1.05rem; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        .correction-box { background: #fff; padding: 15px; border-radius: 15px; border: 1.5px solid #FEB2B2; margin-top: 5px; display: none; line-height: 1.6; font-size: 1.1rem; }
        ins { color: #E53E3E; text-decoration: none; font-weight: 800; background: #FFF5F5; border-radius: 2px; padding: 0 1px; }

        .feedback-overlay { padding: 10px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 10px; display: none; font-size: 0.9rem; }
        .is-correct { background: #E6FFFA; color: #38B2AC; border: 1px solid #38B2AC; }
        .is-wrong { background: #FFF5F5; color: #E53E3E; border: 1px solid #E53E3E; }
        
        .report-item { border-bottom: 1px dashed #cbd5e0; padding: 15px 0; }
        .report-q { font-weight: bold; color: #2D3748; margin-bottom: 5px; }
        .report-ans { font-size: 0.95rem; color: #718096; padding-left: 10px; border-left: 3px solid #CBD5E0; margin-bottom: 5px; }
        .report-corr { font-size: 1rem; color: #E53E3E; font-weight: bold; padding-left: 10px; border-left: 3px solid #E53E3E; }

        .nav-buttons { padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #eee; }
        button { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .btn-prev { background: #EDF2F7; color: #718096; }
        .btn-next { background: var(--point-blue); color: white; }
    </style>
</head>
<body>
<div class="phone-container">
    <div class="header" id="mode-title">LOADING...</div>
    <div id="display-area"></div>
    <div class="nav-buttons" id="nav-btns" style="display:none;">
        <button class="btn-prev" onclick="handlePrev()" id="prev-btn">PREV</button>
        <button class="btn-next" onclick="handleNext()" id="next-btn">NEXT</button>
    </div>
</div>

<script>
    /* Step 2 ê·œì¹™: ë‹¨ì–´ ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ë¹ˆì¹¸ í—ˆìš© */
    const data = [
        { 
            en: "As you listen to your child in an emotional moment, be aware that sharing simple observations usually works better than asking questions to get a conversation rolling.", 
            ko: "ê°ì •ì ì¸ ìˆœê°„ì— ì•„ì´ì˜ ë§ì„ ë“¤ì„ ë•Œ, ì§ˆë¬¸ì„ ë˜ì§€ëŠ” ê²ƒë³´ë‹¤ ë‹¨ìˆœí•œ ê´€ì°°ì„ ê³µìœ í•˜ëŠ” ê²ƒì´ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ëŠ” ë° ëŒ€ê°œ ë” íš¨ê³¼ì ì´ë¼ëŠ” ì ì„ ì•Œì•„ë‘ì„¸ìš”.", 
            voca: ["emotional:ê°ì •ì ì¸", "aware:ì•Œê³ ìˆëŠ”", "sharing:ê³µìœ í•˜ê¸°", "observation:ê´€ì°°", "usually:ëŒ€ê°œ", "works:íš¨ê³¼ê°€ìˆë‹¤", "better:ë”ë‚˜ì€", "asking:ë¬»ê¸°", "rolling:êµ´ëŸ¬ê°€ëŠ”", "conversation:ëŒ€í™”"], 
            grammar: ["ì ‘ì†ì‚¬ As (~í•  ë•Œ)", "ëª…ì‚¬ì ˆ ì ‘ì†ì‚¬ that"], 
            test: "As you listen to your child, <span class='blank' onclick='reveal(this)'>be aware that</span> <span class='blank' onclick='reveal(this)'>sharing simple observations</span> usually <span class='blank' onclick='reveal(this)'>works better than</span> asking questions to get a conversation rolling." 
        },
        { 
            en: "You may ask your child â€œWhy do you feel sad?â€ and she may not have a clue.", 
            ko: "ì—¬ëŸ¬ë¶„ì€ ì•„ì´ì—ê²Œ â€œì™œ ìŠ¬í”„ë‹ˆ?â€ë¼ê³  ë¬¼ì„ ìˆ˜ ìˆì§€ë§Œ, ì•„ì´ëŠ” ì „í˜€ ëª¨ë¥¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.", 
            voca: ["ask:ë¬»ë‹¤", "feel:ëŠë¼ë‹¤", "sad:ìŠ¬í”ˆ", "clue:ì‹¤ë§ˆë¦¬", "may:ì¼ì§€ë„ëª¨ë¥¸ë‹¤", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸ"], 
            grammar: ["ì¡°ë™ì‚¬ may (ì¶”ì¸¡)", "ì˜ë¬¸ë¬¸ ì–´ìˆœ"], 
            test: "You may ask â€œWhy do you feel sad?â€ and <span class='blank' onclick='reveal(this)'>she may not</span> have <span class='blank' onclick='reveal(this)'>a clue</span>." 
        },
        { 
            en: "As a child, she may not have an answer on the tip of her tongue.", 
            ko: "ì•„ì´ë¡œì„œ, ê·¸ë…€ëŠ” ëŒ€ë‹µì´ ì…ì•ˆì—ì„œ ë§´ëŒ ë¿ ë°”ë¡œ ë‚˜ì˜¤ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.", 
            voca: ["answer:ëŒ€ë‹µ", "tip:ë", "tongue:í˜€", "child:ì•„ì´", "have:ê°€ì§€ë‹¤", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸ"], 
            grammar: ["ì „ì¹˜ì‚¬ As (~ë¡œì„œ)", "ê´€ìš©êµ¬ on the tip of tongue"], 
            test: "As a child, she <span class='blank' onclick='reveal(this)'>may not have</span> an answer <span class='blank' onclick='reveal(this)'>on the tip</span> of her tongue." 
        },
        { 
            en: "Maybe sheâ€™s feeling sad about her parentsâ€™ arguments, or because she feels overtired, or sheâ€™s worried about a piano recital.", 
            ko: "ì–´ì©Œë©´ ë¶€ëª¨ë‹˜ì˜ ë§ë‹¤íˆ¼ ë•Œë¬¸ì— ìŠ¬í”ˆ ê²ƒì¼ ìˆ˜ë„ ìˆê³ , ë„ˆë¬´ í”¼ê³¤í•´ì„œì¼ ìˆ˜ë„ ìˆìœ¼ë©°, í”¼ì•„ë…¸ ë…ì£¼íšŒê°€ ê±±ì •ë˜ì–´ì„œì¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.", 
            voca: ["parents:ë¶€ëª¨ë‹˜", "argument:ë§ë‹¤íˆ¼", "overtired:ë„ˆë¬´í”¼ê³¤í•œ", "worried:ê±±ì •ë˜ëŠ”", "recital:ë…ì£¼íšŒ", "piano:í”¼ì•„ë…¸", "feeling:ëŠë¼ëŠ”", "because:ë•Œë¬¸ì—", "maybe:ì•„ë§ˆë„", "about:~ì—ëŒ€í•´"], 
            grammar: ["ë³‘ë ¬ êµ¬ì¡° (or... or...)", "ê°ì • í˜•ìš©ì‚¬ (worried/sad)"], 
            test: "Maybe sheâ€™s feeling <span class='blank' onclick='reveal(this)'>sad about</span> her <span class='blank' onclick='reveal(this)'>parentsâ€™ arguments</span>, or because <span class='blank' onclick='reveal(this)'>she feels overtired</span>, or sheâ€™s <span class='blank' onclick='reveal(this)'>worried about</span> a piano recital." 
        },
        { 
            en: "But she may or may not be able to explain any of this.", 
            ko: "í•˜ì§€ë§Œ ê·¸ë…€ëŠ” ì´ ì¤‘ ì–´ëŠ ê²ƒë„ ì„¤ëª…í•  ìˆ˜ ìˆì„ ìˆ˜ë„, ì—†ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.", 
            voca: ["able:í• ìˆ˜ìˆëŠ”", "explain:ì„¤ëª…í•˜ë‹¤", "any:ì–´ë–¤ê²ƒë„", "this:ì´ê²ƒ", "may:ì¼ì§€ë„ëª¨ë¥¸ë‹¤", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸ"], 
            grammar: ["be able to (~í•  ìˆ˜ ìˆë‹¤)", "may or may not"], 
            test: "But she <span class='blank' onclick='reveal(this)'>may or may not</span> be <span class='blank' onclick='reveal(this)'>able to explain</span> any of this." 
        },
        { 
            en: "And even when she does come up with an answer, she might be worried that the answer is not good enough to justify the feeling.", 
            ko: "ê·¸ë¦¬ê³  ëŒ€ë‹µì´ ìƒê°ë‚  ë•Œì¡°ì°¨, ê·¸ë…€ëŠ” ê·¸ ëŒ€ë‹µì´ ìì‹ ì˜ ê°ì •ì„ ì •ë‹¹í™”í•  ë§Œí¼ ì¶©ë¶„íˆ ì¢‹ì§€ ì•Šë‹¤ê³  ê±±ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.", 
            voca: ["even:ì‹¬ì§€ì–´", "come up with:ìƒê°í•´ë‚´ë‹¤", "might:í• ì§€ë„ëª¨ë¥¸ë‹¤", "enough:ì¶©ë¶„íˆ", "justify:ì •ë‹¹í™”í•˜ë‹¤", "feeling:ê°ì •", "answer:ëŒ€ë‹µ", "good:ì¢‹ì€", "when:~í• ë•Œ", "does:ì •ë§ë¡œ"], 
            grammar: ["ê°•ì¡°ì˜ do (does come up with)", "í˜•ìš©ì‚¬ + enough + toë¶€ì •ì‚¬"], 
            test: "And even when she <span class='blank' onclick='reveal(this)'>does come up</span> with an answer, she might be <span class='blank' onclick='reveal(this)'>worried that</span> the answer is not <span class='blank' onclick='reveal(this)'>good enough to</span> justify the feeling." 
        },
        { 
            en: "Under these circumstances, a series of questions can just make a child silent.", 
            ko: "ì´ëŸ° ìƒí™©ì—ì„œ, ì¼ë ¨ì˜ ì§ˆë¬¸ë“¤ì€ ì•„ì´ë¥¼ ë‹¨ì§€ ì¹¨ë¬µí•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 
            voca: ["circumstance:ìƒí™©", "series:ì¼ë ¨", "question:ì§ˆë¬¸", "make:ë§Œë“¤ë‹¤", "silent:ì¹¨ë¬µí•˜ëŠ”", "these:ì´ëŸ¬í•œ", "child:ì•„ì´", "just:ë‹¨ì§€", "can:í• ìˆ˜ìˆë‹¤", "ğŸ"], 
            grammar: ["5í˜•ì‹ ë¬¸ì¥ (make + O + í˜•ìš©ì‚¬)", "ë³µìˆ˜ ì§€ì‹œ í˜•ìš©ì‚¬ these"], 
            test: "Under these circumstances, <span class='blank' onclick='reveal(this)'>a series of</span> questions can <span class='blank' onclick='reveal(this)'>just make a</span> child silent." 
        },
        { 
            en: "Itâ€™s better to simply reflect what you notice.", 
            ko: "ì—¬ëŸ¬ë¶„ì´ ì•Œì•„ì°¨ë¦° ê²ƒì„ ë‹¨ìˆœíˆ ë°˜ì˜í•˜ëŠ” ê²ƒì´ ë” ë‚«ìŠµë‹ˆë‹¤.", 
            voca: ["better:ë”ë‚˜ì€", "simply:ë‹¨ìˆœíˆ", "reflect:ë°˜ì˜í•˜ë‹¤", "notice:ì•Œì•„ì°¨ë¦¬ë‹¤", "what:~í•˜ëŠ”ê²ƒ", "ğŸ", "ğŸ", "ğŸ", "ğŸ", "ğŸ"], 
            grammar: ["ê°€ì£¼ì–´ It / ì§„ì£¼ì–´ toë¶€ì •ì‚¬", "ê´€ê³„ëŒ€ëª…ì‚¬ what"], 
            test: "Itâ€™s <span class='blank' onclick='reveal(this)'>better to simply</span> reflect <span class='blank' onclick='reveal(this)'>what you notice</span>." 
        },
        { 
            en: "You can say, â€œYou seem a little tired today,â€ or, â€œI noticed that you frowned when I mentioned the recital,â€ and wait for her response.", 
            ko: "â€œì˜¤ëŠ˜ ì¡°ê¸ˆ í”¼ê³¤í•´ ë³´ì´ëŠ”êµ¬ë‚˜â€ë¼ê±°ë‚˜ â€œë‚´ê°€ ë…ì£¼íšŒ ì´ì•¼ê¸°ë¥¼ í–ˆì„ ë•Œ ë„¤ê°€ ëˆˆì‚´ì„ ì°Œí‘¸ë¦¬ëŠ” ê±¸ ë´¤ì–´â€ë¼ê³  ë§í•˜ê³  ì•„ì´ì˜ ë°˜ì‘ì„ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.", 
            voca: ["seem:ë³´ì´ë‹¤", "tired:í”¼ê³¤í•œ", "frowned:ì°¡ê·¸ë¦°", "mentioned:ì–¸ê¸‰í•˜ë‹¤", "wait:ê¸°ë‹¤ë¦¬ë‹¤", "response:ë°˜ì‘", "little:ì¡°ê¸ˆ", "today:ì˜¤ëŠ˜", "noticed:ì•Œì•„ì°¨ë ¸ë‹¤", "say:ë§í•˜ë‹¤"], 
            grammar: ["2í˜•ì‹ ë™ì‚¬ (seem + í˜•ìš©ì‚¬)", "ì§€ê°/ì¸ì§€ ë™ì‚¬ (noticed)"], 
            test: "You can say, <span class='blank' onclick='reveal(this)'>â€œYou seem a</span> little tired today,â€ or, â€œI <span class='blank' onclick='reveal(this)'>noticed that you</span> frownedâ€ and wait for her response." 
        }
    ];

    /* ì´í›„ ë¡œì§ ë™ì¼ */
    const orderData = [
        { id: 1, text: "As you listen to your child in an emotional moment, be aware that sharing simple observations usually works better than asking questions." },
        { id: 2, text: "Children may not always have an answer on the tip of their tongue because they might be tired or worried about a recital." },
        { id: 3, text: "Under these circumstances, a series of questions can make a child silent instead of explaining their feelings." },
        { id: 4, text: "It's better to simply reflect what you notice, like seeing them frown, and wait for their response." }
    ];

    let currentIdx = 0, mode = 'INTRO', round = 1, userOrder = [], history = [], selectedDropIdx = -1, currentTargetIdx = -1, isCorrected = false, isActionDone = false;
    const synth = window.speechSynthesis;

    function render() {
        const area = document.getElementById('display-area'), nextBtn = document.getElementById('next-btn'), prevBtn = document.getElementById('prev-btn'), title = document.getElementById('mode-title'), nav = document.getElementById('nav-btns');
        area.innerHTML = ''; isActionDone = false;

        if (mode === 'INTRO') {
            title.innerText = "2025ë…„ 3ì›” ê³ 1 ëª¨ì˜ê³ ì‚¬ 32ë²ˆ"; nav.style.display = 'none';
            area.innerHTML = `
                <div class="intro-container">
                    <div class="main-title-card"><h1>English Master #32</h1><p>ì§ˆë¬¸ë³´ë‹¤ ê´€ì°°: ì•„ì´ì˜ ë§ˆìŒì„ ì—¬ëŠ” ëŒ€í™”ë²•</p></div>
                    <div class="intro-summary">
                        <h3>ğŸ“‹ ì„œë¡ -ë³¸ë¡ -ê²°ë¡  ìš”ì•½</h3>
                        <p><b>[ì„œë¡ ]</b> ì§ˆë¬¸ë³´ë‹¤ ê´€ì°° ê³µìœ ê°€ ëŒ€í™” ìœ ë„ì— íš¨ê³¼ì ì„.</p>
                        <p><b>[ë³¸ë¡ ]</b> ì•„ì´ëŠ” ê°ì •ì„ ì„¤ëª…í•˜ê¸° ì–´ë µê±°ë‚˜ ì •ë‹¹í™”ì— ë¶€ë‹´ì„ ëŠë‚Œ.</p>
                        <p><b>[ê²°ë¡ ]</b> ë¶€ëª¨ê°€ ê´€ì°°í•œ ë°”ë¥¼ ë‹´ë‹´íˆ ë§í•˜ê³  ê¸°ë‹¤ë ¤ì£¼ëŠ” ê²ƒì´ ì¤‘ìš”.</p>
                    </div>
                    <div class="intro-topic">
                        <span class="topic-label">ğŸ’¡ í•µì‹¬ ì£¼ì œë¬¸</span>
                        <div class="topic-ko">ê°ì •ì ì¸ ì•„ì´ì—ê²ŒëŠ” ì§ˆë¬¸ ì„¸ë¡€ë³´ë‹¤ ë¶€ëª¨ì˜ ê´€ì°°ì„ ì „ë‹¬í•˜ëŠ” ê²ƒì´ ëŒ€í™”ì— ë„ì›€ì´ ëœë‹¤.</div>
                        <div class="topic-en">Instead of questioning, sharing simple observations helps an emotional child speak up.</div>
                    </div>
                    <button class="btn-start" onclick="startLearning()">í•™ìŠµ ì‹œì‘í•˜ê¸°</button>
                </div>`;
        } else if (mode === 'STUDY') {
            title.innerText = `STEP 1. STUDY (${currentIdx + 1}/${data.length})`; nav.style.display = 'flex';
            prevBtn.style.visibility = (currentIdx === 0) ? "hidden" : "visible";
            area.innerHTML = `<div class="sentence-box">${data[currentIdx].en}</div><div class="translation">${data[currentIdx].ko}</div><div class="voca-grid">${data[currentIdx].voca.map(v => `<div class="voca-item" onclick="toggleVoca(this, '${v}')">${v.split(':')[0]}</div>`).join('')}</div><div class="grammar-box">âœ¨ <b>Grammar:</b> ${data[currentIdx].grammar.join(' / ')}</div>`;
            nextBtn.innerText = (currentIdx === data.length - 1) ? "START TEST" : "NEXT";
            playVoice(data[currentIdx].en);
        } else if (mode === 'TEST') {
            title.innerText = `STEP 2. TEST (${currentIdx + 1}/${data.length})`;
            area.innerHTML = `<div class="test-card">${data[currentIdx].test}</div><div class="translation" style="margin-top:20px;">${data[currentIdx].ko}</div>`;
            nextBtn.innerText = (currentIdx === data.length - 1) ? "START ORDERING" : "NEXT";
        } else if (mode === 'ORDER') {
            title.innerText = `STEP 3. ORDERING (ROUND ${round}/5)`;
            if (userOrder.length === 0) this.shuffled = [...orderData].sort(() => Math.random() - 0.5);
            area.innerHTML = `<div id="feedback" class="feedback-overlay"></div>` + this.shuffled.map(o => `<div class="order-box" onclick="selectOrder(this, ${o.id})">${o.text}<div class="order-num"></div></div>`).join('');
            nextBtn.innerText = "CHECK";
        } else if (mode === 'INSERT') {
            title.innerText = `STEP 4. INSERTING (ROUND ${round}/5)`;
            if (selectedDropIdx === -1) currentTargetIdx = Math.floor(Math.random() * (data.length - 1)) + 1;
            let passageHtml = `<div id="feedback" class="feedback-overlay"></div><div class="drag-target-zone" id="drag-box" draggable="true">${data[currentTargetIdx].en}</div><div class="passage-container">`;
            let spotCount = 1;
            const otherSentences = data.filter((_, idx) => idx !== currentTargetIdx);
            otherSentences.forEach((sent, idx) => {
                passageHtml += `<span>${sent.en} </span>`;
                if (spotCount <= 5) {
                    passageHtml += `<span class="num-spot" data-idx="${spotCount}">${spotCount}</span> `;
                    spotCount++;
                }
            });
            area.innerHTML = passageHtml + `</div>`; setupDragEvents(); nextBtn.style.display = 'none';
        } else if (mode === 'WRITE') {
            title.innerText = `STEP 5. WRITING (${currentIdx + 1}/${data.length})`;
            area.innerHTML = `<div class="translation">${data[currentIdx].ko}</div><div class="translation" style="background:var(--mint); border-left-color:var(--point-mint); font-size:0.85rem; line-height:1.4;"><b>Hints:</b> ${data[currentIdx].voca.slice(0,5).map(v=>v.split(':')[0]).join(', ')} | <b>Grammar:</b> ${data[currentIdx].grammar[0]} / ${data[currentIdx].grammar[1]} / ${data[currentIdx].grammar[2] || "ì–´ìˆœì£¼ì˜"}</div><textarea id="student-input" class="writing-input" placeholder="Type here..."></textarea><div id="correction-area" class="correction-box"></div>`;
            nextBtn.innerText = "CHECK & CORRECT"; isCorrected = false;
        } else if (mode === 'REPORT') {
            title.innerText = "MASTER'S FINAL REPORT"; document.getElementById('nav-btns').style.display = 'none';
            let reportHtml = `<div class="report-card" style="padding:10px;">` + history.map((h, i) => `<div class="report-item"><div class="report-q">${i+1}. ${h.ko}</div><div class="report-ans"><b>My Answer:</b> ${h.my || "(empty)"}</div><div class="report-corr"><b>Final Correction:</b> ${h.corr}</div></div>`).join('') + `</div><button onclick="location.reload()" style="margin-top:20px; background:var(--point-blue); color:white; width:100%; border:none; padding:18px; border-radius:15px; font-weight:bold;">COMPLETE & RESTART</button>`;
            area.innerHTML = reportHtml;
        }
    }

    function handleNext() {
        const nextBtn = document.getElementById('next-btn');
        if (mode === 'STUDY') { if (currentIdx < data.length - 1) { currentIdx++; render(); } else { mode = 'TEST'; currentIdx = 0; render(); } }
        else if (mode === 'TEST') { if (currentIdx < data.length - 1) { currentIdx++; render(); } else { mode = 'ORDER'; round = 1; render(); } }
        else if (mode === 'ORDER') {
            if (!isActionDone) { isActionDone = true; const isCorrect = userOrder.join(',') === "1,2,3,4"; const f = document.getElementById('feedback'); f.style.display = 'block'; f.innerText = isCorrect ? "ğŸ‰ CORRECT!" : "âŒ WRONG"; f.className = `feedback-overlay ${isCorrect?'is-correct':'is-wrong'}`; nextBtn.innerText = (round < 5) ? "NEXT ROUND" : "GO TO INSERTING"; }
            else { if (round < 5) { round++; userOrder = []; render(); } else { mode = 'INSERT'; round = 1; render(); } }
        } else if (mode === 'INSERT') { if (round < 5) { round++; selectedDropIdx = -1; render(); } else { mode = 'WRITE'; currentIdx = 0; history = []; render(); } }
        else if (mode === 'WRITE') {
            if (!isCorrected) {
                const input = document.getElementById('student-input'), corrArea = document.getElementById('correction-area'), corrText = data[currentIdx].en, studentVal = input.value.trim();
                history.push({ ko: data[currentIdx].ko, my: studentVal, corr: corrText });
                corrArea.style.display = 'block'; corrArea.innerHTML = `<small style="color:#E53E3E; display:block; font-weight:bold;">[RED PEN]</small>${getDiffHtml(corrText, studentVal)}`;
                nextBtn.innerText = (currentIdx === data.length - 1) ? "VIEW REPORT" : "NEXT SENTENCE"; isCorrected = true;
            } else { if (currentIdx < data.length - 1) { currentIdx++; render(); } else { mode = 'REPORT'; render(); } }
        }
    }

    function getDiffHtml(correct, student) {
        let result = ""; let cArr = correct.split(' '), sArr = student.split(' ');
        cArr.forEach((word, idx) => {
            if (sArr[idx] === word) result += word + " ";
            else if (sArr[idx] === undefined) result += `<ins>${word}</ins> `;
            else {
                let wordDiff = ""; let charCorrect = word.split(''), charStudent = (sArr[idx] || "").split('');
                charCorrect.forEach((c, cIdx) => { if (charStudent[cIdx] === c) wordDiff += c; else wordDiff += `<ins>${c}</ins>`; }); result += wordDiff + " ";
            }
        }); return result.trim();
    }

    function setupDragEvents() {
        const dragBox = document.getElementById('drag-box'), spots = document.querySelectorAll('.num-spot');
        dragBox.addEventListener('dragstart', (e) => e.dataTransfer.setData('text', 'drag'));
        spots.forEach(spot => {
            spot.addEventListener('dragover', (e) => e.preventDefault());
            spot.addEventListener('drop', (e) => { e.preventDefault(); processInsertAnswer(parseInt(spot.dataset.idx), spot); });
            spot.addEventListener('click', () => processInsertAnswer(parseInt(spot.dataset.idx), spot));
        });
    }

    function processInsertAnswer(selectedIdx, el) { 
        isActionDone = true; 
        const isCorrect = (selectedIdx === currentTargetIdx) || (selectedIdx === currentTargetIdx + 1); 
        el.classList.add(isCorrect ? 'correct-spot' : 'wrong-spot'); 
        document.getElementById('feedback').style.display = 'block'; 
        document.getElementById('feedback').innerText = isCorrect ? "ğŸ‰ CORRECT!" : "âŒ WRONG POSITION"; 
        document.getElementById('feedback').className = `feedback-overlay ${isCorrect?'is-correct':'is-wrong'}`; 
        document.getElementById('next-btn').style.display = 'block'; 
    }
    
    function startLearning() { mode = 'STUDY'; currentIdx = 0; render(); }
    function handlePrev() { if (currentIdx > 0) { currentIdx--; render(); } }
    function toggleVoca(el, kor) { if (!el.classList.contains('revealed')) { el.innerText = kor; el.classList.add('revealed'); } else { el.innerText = el.innerText.split(':')[0]; el.classList.remove('revealed'); } }
    function selectOrder(el, id) { if (isActionDone || el.classList.contains('selected')) return; userOrder.push(id); el.classList.add('selected'); el.querySelector('.order-num').innerText = userOrder.length; el.querySelector('.order-num').style.display = 'flex'; }
    function reveal(el) { el.classList.add('revealed'); }
    function playVoice(text) { synth.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.85; synth.speak(u); }

    window.onload = render;
</script>
</body>
</html>