<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI íšŒí™” í•™ìŠµ & ì„±ì í‘œ</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; text-align: center; padding: 20px; background: #fdfcf0; margin: 0; }
        .container { background: white; max-width: 450px; margin: 10px auto; padding: 20px; border-radius: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .screen { display: none; } 
        .active { display: block; }
        button { padding: 15px; font-size: 17px; font-weight: bold; cursor: pointer; border-radius: 15px; border: none; margin: 10px 0; width: 100%; transition: 0.2s; }
        .lvl-btn { background: #2ECC71; color: white; }
        .sentence-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        .mic-btn { background: #E74C3C; color: white; font-size: 20px; height: 70px; }
        .mic-btn.recording { background: #c0392b; animation: pulse 1.2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        #recognizedText { margin-top: 20px; font-size: 16px; color: #666; min-height: 40px; padding: 10px; background: #f9f9f9; border-radius: 10px; border: 1px dashed #ccc; }
        #resultMsg { margin-top: 15px; font-weight: bold; font-size: 20px; }
        .next-btn { background: #3498db; color: white; display: none; }
        
        /* ì„±ì í‘œ ë””ìì¸ */
        #report-card { background: white; padding: 30px; border: 5px solid #4A90E2; border-radius: 20px; text-align: center; }
        .score-big { font-size: 50px; color: #E74C3C; font-weight: bold; margin: 20px 0; }
        .wrong-list { text-align: left; font-size: 14px; background: #fff5f5; padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="level-screen" class="screen active">
        <h2 style="margin-top:30px;">AI íšŒí™” í•™ìŠµ ì‹œì‘</h2>
        <div style="max-width:300px; margin: 0 auto;">
            <button class="lvl-btn" onclick="startApp(1)">Level 1 ì—°ìŠµí•˜ê¸°</button>
            <button class="lvl-btn" onclick="startApp(2)">Level 2 ì—°ìŠµí•˜ê¸°</button>
        </div>
    </div>

    <div id="study-screen" class="screen">
        <div class="container">
            <h3>ì˜¤ëŠ˜ì˜ ë¬¸ì¥ ë¯¸ë¦¬ë³´ê¸°</h3>
            <div id="sentence-list"></div>
            <button onclick="startQuiz()" style="background:#E74C3C; color:white; margin-top:20px;">ë‹¤ ì™¸ì› ì–´ìš”! ì‹œí—˜ ì‹œì‘ ğŸ‘‰</button>
        </div>
    </div>

    <div id="quiz-screen" class="screen">
        <div class="container">
            <div id="info"></div>
            <div id="koreanQ" style="font-size:24px; font-weight:bold; margin:15px 0;"></div>
            <div id="recognizedText">ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§í•˜ì„¸ìš”.</div>
            <button id="micBtn" class="mic-btn" onclick="toggleListening()">ğŸ¤ ë§í•˜ê¸° ì‹œì‘</button>
            <button id="nextBtn" class="next-btn" onclick="nextSentence()">ë‹¤ìŒ ë¬¸ì¥ ğŸ‘‰</button>
            <div id="resultMsg"></div>
        </div>
    </div>

    <div id="report-screen" class="screen">
        <div id="report-area" style="padding:10px; background:#f0f0f0;">
            <div id="report-card">
                <h2 style="margin:0;">ENGLISH SPEAKING REPORT</h2>
                <p id="report-date"></p>
                <hr>
                <div class="score-big" id="final-score">0ì </div>
                <p id="score-summary"></p>
                <div class="wrong-list" id="wrong-container" style="display:none;">
                    <p><strong>âš ï¸ ë³µìŠµì´ í•„ìš”í•œ ë¬¸ì¥:</strong></p>
                    <div id="wrong-items"></div>
                </div>
                <h3 style="margin-top:20px; color:#4A90E2;">Excellent Effort! ğŸ‘</h3>
            </div>
        </div>
        <div class="container">
            <button onclick="saveAsImg()" style="background:#2ECC71; color:white;">ğŸ“¸ ì„±ì í‘œ ì´ë¯¸ì§€ë¡œ ì €ì¥í•˜ê¸°</button>
            <button onclick="location.reload()" style="background:#eee;">ë‹¤ì‹œ í•˜ê¸°</button>
        </div>
    </div>

    <script>
        let sentences = [];
        let currentIdx = 0;
        let score = 0;
        let wrongAnswers = [];

        function speak(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'en-US';
            window.speechSynthesis.speak(uttr);
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if(recognition) { recognition.lang = 'en-US'; recognition.interimResults = false; }

        function startApp(level) {
            fetch(`speak${level}.json`).then(res => res.json()).then(data => {
                sentences = data;
                showStudyList();
            });
        }

        function showStudyList() {
            document.getElementById('level-screen').classList.remove('active');
            document.getElementById('study-screen').classList.add('active');
            const listDiv = document.getElementById('sentence-list');
            listDiv.innerHTML = "";
            sentences.forEach(item => {
                listDiv.innerHTML += `<div class="sentence-item">
                    <span><strong>${item.Korean}</strong><br><small>${item.English}</small></span>
                    <button style="width:40px; height:40px; padding:0;" onclick="speak('${item.English}')">ğŸ”Š</button>
                </div>`;
            });
        }

        function startQuiz() {
            document.getElementById('study-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            currentIdx = 0; score = 0; wrongAnswers = [];
            showQuiz();
        }

        function showQuiz() {
            if (currentIdx < sentences.length) {
                document.getElementById('koreanQ').innerText = sentences[currentIdx].Korean;
                document.getElementById('info').innerText = `ë¬¸ì¥ ${currentIdx + 1} / ${sentences.length}`;
                document.getElementById('recognizedText').innerText = "ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
                document.getElementById('resultMsg').innerText = "";
                document.getElementById('micBtn').style.display = "block";
                document.getElementById('nextBtn').style.display = "none";
            } else { showReport(); }
        }

        function toggleListening() { try { recognition.start(); } catch (e) { recognition.stop(); } }

        if(recognition) {
            recognition.onstart = () => { document.getElementById('micBtn').innerText = "ğŸ§ ë“£ê³  ìˆì–´ìš”..."; };
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript.toLowerCase().replace(/[.?!,]/g, "").trim();
                document.getElementById('recognizedText').innerText = `ì¸ì‹ ê²°ê³¼: "${speechResult}"`;
                checkAnswer(speechResult);
            };
            recognition.onend = () => { document.getElementById('micBtn').innerText = "ğŸ¤ ë‹¤ì‹œ ë§í•˜ê¸°"; };
        }

        // ìœ ì—°í•œ ì •ë‹µ ì²´í¬ ë¡œì§ (ê¸€ì í¬í•¨ ì—¬ë¶€ ë“±ìœ¼ë¡œ íŒë‹¨)
        function checkAnswer(speech) {
            const correct = sentences[currentIdx].English.toLowerCase().replace(/[.?!,]/g, "").trim();
            const resultArea = document.getElementById('resultMsg');

            // ì •í™•íˆ ì¼ì¹˜í•˜ê±°ë‚˜, ì •ë‹µ ë¬¸ì¥ì˜ 70% ì´ìƒì´ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì •ë‹µ ì²˜ë¦¬
            if(speech === correct || speech.includes(correct) || correct.includes(speech)) {
                resultArea.innerText = "â­• Good Job!";
                resultArea.style.color = "#2ECC71";
                score++;
                document.getElementById('micBtn').style.display = "none";
                document.getElementById('nextBtn').style.display = "block";
                speak(correct);
            } else {
                resultArea.innerText = "âŒ ì¡°ê¸ˆ ë” ë¹„ìŠ·í•˜ê²Œ ë§í•´ë³¼ê¹Œìš”?";
                resultArea.style.color = "#E74C3C";
                // í‹€ë ¤ë„ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ 2ì´ˆ í›„ ë²„íŠ¼ ë…¸ì¶œ (ê°•ì œ í†µê³¼ìš©)
                setTimeout(() => {
                    if(document.getElementById('nextBtn').style.display === "none") {
                        resultArea.innerText = "ì—°ìŠµí–ˆìœ¼ë‹ˆ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°ˆê²Œìš”! ğŸ‘";
                        wrongAnswers.push(sentences[currentIdx]);
                        document.getElementById('micBtn').style.display = "none";
                        document.getElementById('nextBtn').style.display = "block";
                    }
                }, 2500);
            }
        }

        function nextSentence() { currentIdx++; showQuiz(); }

        function showReport() {
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('report-screen').classList.add('active');
            
            const finalPercent = Math.round((score / sentences.length) * 100);
            document.getElementById('final-score').innerText = finalPercent + "ì ";
            document.getElementById('report-date').innerText = new Date().toLocaleDateString() + " í•™ìŠµ ê²°ê³¼";
            document.getElementById('score-summary').innerText = `ì´ ${sentences.length}ë¬¸ì¥ ì¤‘ ${score}ë¬¸ì¥ ì„±ê³µ!`;

            if(wrongAnswers.length > 0) {
                document.getElementById('wrong-container').style.display = "block";
                const itemDiv = document.getElementById('wrong-items');
                itemDiv.innerHTML = "";
                wrongAnswers.forEach(w => {
                    itemDiv.innerHTML += `<p style="margin:5px 0;">â€¢ ${w.Korean}: <strong>${w.English}</strong></p>`;
                });
            }
        }

        // ì„±ì í‘œ ì´ë¯¸ì§€ ì €ì¥ ê¸°ëŠ¥
        function saveAsImg() {
            const area = document.getElementById('report-area');
            html2canvas(area).then(canvas => {
                const link = document.createElement('a');
                link.download = 'my_english_score.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        }
    </script>
</body>
</html>